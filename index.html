<!DOCTYPE html>
<meta charset='utf-8'>
<head>
  <title>Floating Library</title>
  <script src='http://code.jquery.com/jquery-2.2.1.min.js'></script>
  <script src='./javascript/regression.js'></script>
</head>
<body>

  <link rel="stylesheet" href="style.css" />

  <div id="displacementGraphics">
    <div id="lineGraphContainer">
      <p>Compare the distribution of floating books from home libraries to current locations.</p>
      <div id="homeCheckboxes" class='selectorList'>
        <p class='allLibrariesSelector checkboxContainer'>
          <input id='homeAllLibrariesSelector' type='button' value="All">
        </p>
      </div>
      <div id="currentCheckboxes" class='selectorList'>
        <p class='allLibrariesSelector checkboxContainer'>
          <input type='button' id='currentAllLibrariesSelector' value="All">
        </p>
      </div>
      <div id="lineGraph">
      </div>
      <div class="captions">
        <p id="lineGraphCaption1" class="caption"></p>
        <p id="lineGraphCaption2" class="caption"></p>
      </div>
    </div>
    <div id="matrices"></div>
  </div>

  <div id="recencyGraphics">
    <h2>Recency of Library Collections</h2>
    <input class='slider' id="recencySlider" type="range" min="0" max="17" step = "1" value="0">
    <div id="recencyBarChart"></div>
  </div>

<script src='//d3js.org/d3.v3.min.js'></script>
<script src='http://d3js.org/queue.v1.min.js'></script>

<script>

var libraryCodes = ['AA','AB','BR','BK','BD','DE','DS','FE','MK','HB','HN','LV','MA','NK','SL','SV','WB','WS','YK'];
var snapshots;

</script>

<!-- load view specific scripts -->
<script src="draw-displacement-graphics.js"></script>

<script>

queue().defer(d3.json, 'data/snapshots.json').awaitAll(prepped)

// load each snapshot's data
function prepped(error, results) {
  if (error) throw error;
  snapshots = results;
  var waiting = queue()
  results[0].map(function(d) {
    waiting.defer(d3.json, 'data/' + d + '_displacement.json');
    waiting.defer(d3.json, 'data/' + d + '_recency.json');
    waiting.defer(d3.json, 'data/' + d + '_call_number.json');
  });
  waiting.awaitAll(ready)
}

// all ready to go
function ready(error, data) {
  if (error) throw error;

  var displacementData = [],
      recencyData = [],
      callNumberData = [];

  data.map(function(d) {
    if (d.length > 0) {
      displacementData.push(d);
    };
    if (d['3 - 5 years']) {
      recencyData.push(d);
    };
    if (d['B'] && d['N']) {
      callNumberData.push(d);
    }
  });

  drawDisplacementGraphics(displacementData);
  console.log('recency', recencyData);
  drawRecencyGraphics(recencyData);
  console.log('call numbers', callNumberData);
}

function drawRecencyGraphics(data) {

  var categories = ['less than 3 years', '3 - 5 years', '6 - 10 years', '11 - 25 years', '26 - 50 years', '51 - 100 years', 'more than 100 years'];

  var recency = data.map(function(s) {
    var libraries = [];
    for (var i = 0; i < libraryCodes.length; i++) { libraries.push([]); }
    for (d in s) {
      s[d].map(function(v,i) {
        libraries[i][categories.indexOf(d)] = v;
      })
    }
    return libraries;
  });
  console.log('restructured', recency);

  var svg = d3.select('#recencyBarChart').append('svg')
    .attr('width', 900)
    .attr('height', 400);

  function drawSnapshotRecency(snapIndex) {
    svg.selectAll('.plot').remove();
    var plot = svg.selectAll('g')
      .data(recency[snapIndex])
     .enter().append('g')
      .attr('class', 'plot')
      .attr('transform', function(d,i) { return 'translate(' + 900 / libraryCodes.length * i + ',0)'; })
      .datum(function(d) { return d; });

    var colors = ['#ffffcc','#d9f0a3','#addd8e','#78c679','#41ab5d','#238443','#005a32'];
    plot.selectAll('.bar')
      .data(function(d) { return d; })
     .enter().append('rect')
      .attr('class', 'bar')
      .attr('x', function(d,i) { return (900 / libraryCodes.length / categories.length) * i; })
      .attr('width', (900 / libraryCodes.length / categories.length - 2))
      .attr('y', function(d) { return 400 - d / 100; })
      .attr('height', function(d) { return d / 100; })
      .style('fill', function(d,i) { return colors[colors.length - i - 1] })
  }

  d3.select('#recencySlider').on('change', function() {
    drawSnapshotRecency(this.value)
  });


}

</script>
</body>
