<!DOCTYPE html>
<meta charset='utf-8'>
<head>
  <title>Floating Library</title>
  <script src='http://code.jquery.com/jquery-2.2.1.min.js'></script>
  <script src='./javascript/regression.js'></script>
</head>
<body>

  <link rel="stylesheet" href="style.css" />

  <div id="displacementGraphics">
    <div id="lineGraphContainer">
      <p>Compare the distribution of floating books from home libraries to current locations.</p>
      <div id="homeCheckboxes" class='selectorList'>
        <p class='allLibrariesSelector checkboxContainer'>
          <input id='homeAllLibrariesSelector' type='button' value="All">
        </p>
      </div>
      <div id="currentCheckboxes" class='selectorList'>
        <p class='allLibrariesSelector checkboxContainer'>
          <input type='button' id='currentAllLibrariesSelector' value="All">
        </p>
      </div>
      <div id="lineGraph">
      </div>
      <div class="captions">
        <p id="lineGraphCaption1" class="caption"></p>
        <p id="lineGraphCaption2" class="caption"></p>
      </div>
    </div>
    <div id="matrices"></div>
  </div>

  <div id="recencyGraphics">
    <h2>Recency of Library Collections</h2>
    <input class='slider' id="recencySlider" type="range" min="0" max="17" step = "1" value="0">
    <div id="recencyBarChart"></div>
  </div>

  <div id="callNumberGraphics">
    <h2>Call Numbers</h2>
    <div id='menu'>
      <div class="selector">
        Classification:
        <select id='classMenu'>
          <option value="main">Main Classes</option>
        </select>
      </div>
    </div>
    <input class='slider' id="cnSlider" type="range" min="0" max="17" step = "1" value="0">
    <div id="callNumberChart"></div>
  </div>

<script src='//d3js.org/d3.v3.min.js'></script>
<script src='http://d3js.org/queue.v1.min.js'></script>

<script>

var libraryCodes = ['AA','AB','BR','BK','BD','DE','DS','FE','MK','HB','HN','LV','MA','NK','SL','SV','WB','WS','YK'];
var snapshots,classifications;

</script>

<!-- load view specific scripts -->
<script src="draw-displacement-graphics.js"></script>
<script src="draw-recency-graphics.js"></script>

<script>

queue().defer(d3.json, 'data/snapshots.json').defer(d3.json, 'data/classifications.json').awaitAll(prepped);

var snapFormat = d3.time.format('%Y%m%d'),
  displayFormat = d3.time.format('%B, %Y');

// load each snapshot's data
function prepped(error, results) {
  if (error) throw error;
  snapshots = results[0];
  classifications = results[1];
  var waiting = queue()
  results[0].map(function(d) {
    waiting.defer(d3.json, 'data/' + d + '_displacement.json');
    waiting.defer(d3.json, 'data/' + d + '_recency.json');
    waiting.defer(d3.json, 'data/' + d + '_call_number.json');
  });
  waiting.awaitAll(ready)
}

// all ready to go
function ready(error, data) {
  if (error) throw error;

  var displacementData = [],
      recencyData = [],
      callNumberData = [];

  data.map(function(d) {
    if (d.length > 0) {
      displacementData.push(d);
    };
    if (d['3 - 5 years']) {
      recencyData.push(d);
    };
    if (d['B'] && d['N']) {
      callNumberData.push(d);
    }
  });

  drawDisplacementGraphics(displacementData);
  console.log('recency', recencyData);
  drawRecencyGraphics(recencyData);
  console.log('call numbers', callNumberData);
  drawCallNumberGraphics(callNumberData);
}

function drawCallNumberGraphics(data) {
  var firstSnapshotData = restructureCallNumbers(data[0]);

  for (main in firstSnapshotData) {
    if (main != 'libraryTotals') $('#classMenu').append('<option value="' + main + '">' + main + '</option>')
  }
  $('#classMenu').change(function() {
    updateCallNumberChart(data);
  });
  $('#cnSlider').change(function() {
    updateCallNumberChart(data);
  })

  function updateCallNumberChart(data) {

    var snapData = data[$('#cnSlider').val()];

    var chartData = restructureCallNumbers(snapData);

    var maxCount = 0;
    for (main in chartData) {
      if (chartData[main].total > maxCount) maxCount = chartData[main].total;
    }

    var systemTotal = d3.sum(chartData.libraryTotals);

    var focus = $('#classMenu').val();

    var charts = [];
    if (focus === 'main') {
      for (main in chartData) {
        if (main !== 'libraryTotals') {
          var callNumber = main;
          var netProportionValues = chartData[main].libraryProportions.map(function(d,i) {
            return d - (chartData[main].total / systemTotal);
          });
          var chart = {
            'callNumber': callNumber,
            'values': netProportionValues,
            'counts': chartData[main].libraries
          };
          charts.push(chart);
        }
      }
    } else {
      for (sub in chartData[focus].subclasses) {
        var callNumber = focus === sub ? focus : focus + sub;
        var netProportionValues = chartData[focus].subclasses[sub].libraryProportions.map(function(d,i) {
          return d - (chartData[focus].subclasses[sub].total / systemTotal);
        })
        var chart = {
          'callNumber': callNumber,
          'values': netProportionValues,
          'counts': chartData[focus].subclasses[sub].libraries
        };
        charts.push(chart);
      }
    }

    var margin = 12;

    var height = 170 + 2 * margin,
        width = 310 + 2 * margin;

    var color = d3.scale.linear()
      .domain([0, maxCount / 1000, maxCount / 500, maxCount / 50, maxCount / 2, maxCount])
      .range(['#a6bddb','#67a9cf','#3690c0','#02818a','#016450']);

    d3.select('#callNumberChart').selectAll('.plot').remove();
    var cnSvg = d3.select('#callNumberChart').selectAll('.plot')
      .data(charts)
     .enter().append('svg')
      .attr('class', 'plot')
      .attr('height', height)
      .attr('width', width);

    var cnGroups = cnSvg.selectAll('.cnGroup')
      .data(function(d) {
        var zipped = d3.zip(d.values, d.counts);
        var max = d3.max(d.values),
            min = d3.min(d.values);
        var extreme = Math.abs(max) > Math.abs(min) ? max : min;
        zipped.map(function(d) { d.push(Math.abs(extreme)); return d; });
        return zipped;
      })
     .enter().append('g')
      .attr('transform', function(d,i) { return 'translate(' + (((width - 2 * margin) / libraryCodes.length) * i + margin) + ',0)'; })

   cnGroups.append('rect')
    .attr('class', 'bar')
    .attr('width', ((width - 2 * margin) / libraryCodes.length - 2))
    .attr('y', function(d) {
      return d[0] < 0 ?
        (height - 2 * margin) / 2 + (d[0] / d[2] * (height - 2 * margin) / 2) + margin :
        (height - 2 * margin) / 2 + margin;
    })
    .attr('height', function(d) {
      return Math.abs((d[0] / d[2])) * (height - 2 * margin) / 2;
    })
    .style('fill', function(d) {
      return color(d[1]);
    });

    cnGroups
      .append('text')
      .attr('class', 'label')
      //.attr('x', 2 + margin)
      .attr('y', function(d) {
        var pad = d[0] < 0 ? -1 * margin / 4 : margin / 4;
        return ((height - 2 * margin) / 2 + margin - 1) + ((d[0] / d[2])) * (height - 2 * margin) / 2 + pad;
      })
      .attr('alignment-baseline', function(d) { return d[0] > 0 ? 'hanging' : 'auto' })
      .text(function(d,i) { return libraryCodes[i]; });

    cnSvg
      .append('text')
      .attr('class', 'classLabel label')
      .attr('x', 2 + margin)
      .attr('y', 2 + margin)
      .attr('alignment-baseline', 'hanging')
      .text(function(d) { return d.callNumber; });

    cnSvg
      .append('text')
      .attr('class', 'dateLabel label')
      .attr('x', width - (0 + margin))
      .attr('y', height - (0 + margin))
      .attr('text-anchor', 'end')
      .text(function(d,i) { return displayFormat(
          snapFormat.parse(
            snapshots[$('#cnSlider').val()]
          )
        );
      });

  }

  updateCallNumberChart(data);

}

function restructureCallNumbers(cnData) {

  var empty = [];
  while (empty.length < libraryCodes.length) {
    empty.push(0);
  }

  var restructured = { libraryTotals: empty.slice() };

  for (cn in cnData) {
    cnData[cn].map(function(d,i) { restructured.libraryTotals[i] += d; });
  }

  for (letter in classifications) {
    var generalClass = letter.substring(0,1),
        subClass = letter.substring(1,letter.length);
    if (restructured[generalClass]) {
      restructured[generalClass].subclasses[subClass] = { total: 0, libraries: cnData[letter] };
      restructured[generalClass].subclasses[subClass].total += d3.sum(cnData[letter]);
    } else {
      restructured[generalClass] = { total: 0, subclasses: {}, libraries: empty.slice() };
      restructured[generalClass].subclasses[generalClass] = { total: 0, libraries: cnData[letter], libraryProportions: empty.slice() };
      restructured[generalClass].subclasses[generalClass].total += d3.sum(cnData[letter]);
    }
  }

  for (general in restructured) {
    if (general !== 'libraryTotals') {

      for (sub in restructured[general].subclasses) {
        restructured[general].subclasses[sub].libraries.map(function(d,i) {
          restructured[general].libraries[i] += d;
        })
      }

      restructured[general].libraryProportions = restructured[general].libraries.map(function(d,i) {
        return d / restructured['libraryTotals'][i];
      });

      for (sub in restructured[general].subclasses) {
        restructured[general].subclasses[sub].libraryProportions = restructured[general].subclasses[sub].libraries.map(function(d,i) {
          return d / restructured['libraryTotals'][i];
        });
        restructured[general].total += restructured[general].subclasses[sub].total;
      }
    }
  }

  return restructured;

}



</script>
</body>
